<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% if content and content.title %}{{ content.title | striptags }}{% else %}Fortune Teller{% endif %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <main class="container">
      {% block content %}{% endblock %}
    </main>
    
    <!-- On-Screen Keyboard -->
    <div id="keyboard-container" class="keyboard-container" style="display: none;">
      <div class="keyboard">
        <div class="keyboard-row">
          <button class="key" data-key="q">q</button>
          <button class="key" data-key="w">w</button>
          <button class="key" data-key="e">e</button>
          <button class="key" data-key="r">r</button>
          <button class="key" data-key="t">t</button>
          <button class="key" data-key="y">y</button>
          <button class="key" data-key="u">u</button>
          <button class="key" data-key="i">i</button>
          <button class="key" data-key="o">o</button>
          <button class="key" data-key="p">p</button>
          <button class="key key-backspace" data-key="backspace">âŒ«</button>
        </div>
        <div class="keyboard-row">
          <button class="key" data-key="a">a</button>
          <button class="key" data-key="s">s</button>
          <button class="key" data-key="d">d</button>
          <button class="key" data-key="f">f</button>
          <button class="key" data-key="g">g</button>
          <button class="key" data-key="h">h</button>
          <button class="key" data-key="j">j</button>
          <button class="key" data-key="k">k</button>
          <button class="key" data-key="l">l</button>
          <button class="key" data-key="space">+</button>
        </div>
        <div class="keyboard-row">
          <button class="key" data-key="z">z</button>
          <button class="key" data-key="x">x</button>
          <button class="key" data-key="c">c</button>
          <button class="key" data-key="v">v</button>
          <button class="key" data-key="b">b</button>
          <button class="key" data-key="n">n</button>
          <button class="key" data-key="m">m</button>
          <button class="key key-enter" data-key="enter">enter</button>
        </div>
      </div>
    </div>

    <script>
      // Virtual keyboard functionality
      let activeInput = null;

      // Show keyboard when input is focused
      document.addEventListener('focusin', function(e) {
        if (e.target.matches('input[type="text"]')) {
          activeInput = e.target;
          showKeyboard(e.target);
        }
      });

      // Handle keyboard button clicks
      document.querySelectorAll('.key').forEach(key => {
        key.addEventListener('click', function(e) {
          e.preventDefault();
          if (!activeInput) return;
          
          const keyValue = this.getAttribute('data-key');
          
          if (keyValue === 'backspace') {
            activeInput.value = activeInput.value.slice(0, -1);
          } else if (keyValue === 'space') {
            activeInput.value += ' ';
          } else if (keyValue === 'enter') {
            // Submit the form containing the active input
            const form = activeInput.closest('form');
            if (form) {
              form.submit();
            }
          } else if (keyValue) {
            activeInput.value += keyValue;
          }
          
          // Trigger input event for any validation
          activeInput.dispatchEvent(new Event('input', { bubbles: true }));
        });
      });

      // Click outside to close keyboard
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.keyboard-container') && 
            !e.target.matches('input[type="text"]')) {
          hideKeyboard();
        }
      });

      function showKeyboard(inputElement) {
        const keyboard = document.getElementById('keyboard-container');
        
        keyboard.style.display = 'block';
        keyboard.style.position = 'fixed';
        
        // Position keyboard on the right side, vertically centered
        keyboard.style.right = '100px';  // Move further left
        keyboard.style.top = '50%';
        keyboard.style.transform = 'translateY(-50%)';  // Vertically center
        keyboard.style.left = 'auto';  // Reset left positioning
      }

      function hideKeyboard() {
        document.getElementById('keyboard-container').style.display = 'none';
        activeInput = null;
      }

      // Admin keyboard shortcut to exit kiosk mode
      // Press Ctrl+Shift+E to exit (requires confirmation)
      let exitKeyPressed = false;
      document.addEventListener('keydown', function(e) {
        // Check for Ctrl+Shift+E
        if (e.ctrlKey && e.shiftKey && e.key === 'E') {
          e.preventDefault();
          
          if (!exitKeyPressed) {
            exitKeyPressed = true;
            const confirmed = confirm('Exit kiosk mode? This will stop the Fortune Cookie service.');
            if (confirmed) {
              // Call API endpoint to exit kiosk
              fetch('/api/exit-kiosk', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                  if (data.success) {
                    alert('Kiosk mode will exit. The page will close shortly.');
                    // Close the window after a short delay
                    setTimeout(() => {
                      window.close();
                    }, 2000);
                  } else {
                    alert('Error: ' + (data.error || 'Failed to exit kiosk mode'));
                    exitKeyPressed = false;
                  }
                })
                .catch(error => {
                  console.error('Error exiting kiosk:', error);
                  alert('Error exiting kiosk mode. You may need to exit manually via SSH or TTY.');
                  exitKeyPressed = false;
                });
            } else {
              exitKeyPressed = false;
            }
          }
        }
      });
    </script>
  </body>
</html>
